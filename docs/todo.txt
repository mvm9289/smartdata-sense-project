--------------------------------------------------------------------------------
Trabajo
--------------------------------------------------------------------------------
Datagrama aplicación
- (Bea)Estructura datos "packet"" con tipos básicos:
1. ID mota (2B)
2. Tipo mensaje (1B)
- Hello "basestation" -> 0x1
- Hello "mobile node" -> 0x2
- Datos -> 0x3
- Ack -> 0x4
- Poll -> 0x5
3. Size (2B) Tamaño de los datos
4. Contador (2B) Offset del fichero enviado (0, 32, ..)
5. Datos (32B)
6. Reservado (23B)
7. Checksum (2B) de los campos anteriores

- (Bea)Función que construye un "array" preparado para RIME a partir de una estructura "packet".
- (Bea)Función que construye la estructura "packet" a partir de un "array" proporcionado por RIME.

--------------------------------------------------------------------------------
Libreria
--------------------------------------------------------------------------------
zt-packet-mt.h

#define SINK_ADDR1
#define SINK_ADDR2
#define HELLO_BS
#define HELLO_MN
#define DATA
#define ACK
#define POLL


struct Packet {
  unsigned char addr1;
  unsigned char addr2;
  unsigned char type;
  unsigned short size;
  unsigned short counter;
  unsigned char data[32];
  unsgined char reserved[23];
  unsgined short checksum;
}

unsigned short compute_checksum((struct Packet *)my_packet);
unsigned char * mount_packet((struct Packet *)my_packet);
struct Packet unmount_packet((unsigned char*)my_array);

--------------------------------------------------------------------------------
Compilacion
--------------------------------------------------------------------------------
Modificaciones realizadas:
1. Fichero "contiki/Makefile.include"
   Seccion: LIBS
   Anadido "zt-packet-mgmt.c"
   
2. Directorio "contiki/core/lib/"
   Copiados los ficheros "zt-packet-mgmt.h" y "zt-packet-mgmt.c"

3. Fichero "zt-packet-mgmt.h"
   Añadida definicion del fichero de cabezeras (ifndef __ZT_PACKET_MGMT_H ...)
   
--------------------------------------------------------------------------------
Funcionalidades
--------------------------------------------------------------------------------
Basestation
- (MA)Añadir "timestamp" estructura de la tabla de nodos.
- (MA)Función que actualiza el "timestamp" y comprueba si debe eliminarla de la tabla (timeout).
- (MA) Función que comprueba "checksum" de los paquetes y si es correcto envía un paquete "ack" al nodo.
- (MA)Función de envío de paquete "hello" en "broadcast" a la red, al iniciarse y cada 1 hora.
- (MA)Función de envío de paquete "poll" pasados 10 minutos sin recibir datos del nodo móvil.
* Enviar paquetes de datos correctos al "gateway".

Nodos móviles
- (Carlos)Función de envío de paquete "hello" a la "basestation", al iniciarse y cuando recibe un paquete "hello" de la "basestation".
  (!) Primer "HELLO_MN"
  - Enviamos datos a pesar de no recibir "ACK"

- (Carlos)Función de envío de paquete, de respuesta a "poll" y, normal de datos cada 10 minutos, con todos los datos del fichero y 5 reintentos.

  (!)Envio de un archivo
  ¿Necesitamos confirmar cada paquete?
  Modelo definido:
    En estado 'Data Send' envio el primer paquete.
    En estado 'Data Ack Received' envio el siguiente. Si no hay siguiente, 
    elimino el archivo (para posteriormente crear uno nuevo)

- (Carlos)Función que al recibir un paquete "ack" de la "basestation" borra el fichero actual y abre uno nuevo.
    
  (!) Distincion de "Ack"
  Modelo definido:
    - Diferenciar "HELLO ACK" y "DATA ACK" como tipos diferentes de mensajes

- (Carlos)Función de toma de datos del sensor cada 1 minuto.

  (!) Obtencion del dato del sensor
  Modelo definido:
    - Lo leemos y lo almacenamos en un "char" (ajustar cuando tengamos 
    microfonos)
    - No hay separador (tener encuenta gateway)

- (Carlos) Funcion principal de control de estados
  Modelo definido:
    - Timer único control de "Data Collect" y "Data Send" (1 minuto)
    - Suposicion: mensajes BS interrumpen y toman el control  

--------------------------------------------------------------------------------
Maquina de estados (MN)
--------------------------------------------------------------------------------
Blocked
- Al inicio -> Data Send ("hello" packet)
- Timer de 1 segundo
- Al cabo de 1 minuto -> Data Collect
- Al cabo de 10 Data Collect -> Data Send
- Al cabo de 10 minutos -> Data Send ("hello" packet)

Data Send | Poll
- Al cabo de 1 segundo -> Data Resend
- Recibo ACK -> Blocked (borrar fichero, crear nuevo)

Data Resend
- Al cabo de 5 intentos -> Blocked

--------------------------------------------------------------------------------
Pruebas
--------------------------------------------------------------------------------
Realizar pruebas de simulación de entorno (si es necesario utilizaremos antenas)
Utilizar parametros calidad de transmisión

--------------------------------------------------------------------------------
Comunicacion Gateway-Basestation
--------------------------------------------------------------------------------
A traves de "write", "printf" teniendo en cuenta la dificultad del Gateway al
recibir la informacion

--------------------------------------------------------------------------------
